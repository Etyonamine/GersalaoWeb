<div class="container">
    <mat-card>
        <mat-card-title class="titulo">
            {{tituloPagina}}
        </mat-card-title>
        <mat-card-content>

            <form [formGroup]="formulario" (ngSubmit)="submit()">
                <div>
                    <input id="mensagemFuncionamento" name = "mensagemFuncionamento" readonly class="mensagemFuncionamento" value="O horário de funcionamento do estabelecimento : {{horaInicioDefault}} &agrave; {{ horaFimDefault}}">
                </div>
                <div>
                    <!--Data-->
                    <mat-form-field appearance="fill" class="campo-DataHora">
                        <mat-label>Data</mat-label>
                        <input matInput type="date" formControlName="dataAgenda"   required>
                    </mat-form-field>
                    <!--Hora inicio-->
                    <mat-form-field appearance="fill"  class="campoHora" >
                        <mat-label>In&iacute;cio</mat-label>
                        <input matInput type="time" 
                              formControlName="horaInicio"   
                                           
                              required               
                             >
                    </mat-form-field>
                    <!--Hora de termino-->
                    <mat-form-field appearance="fill"  class="campoHora" >
                        <mat-label>T&eacute;rmino</mat-label>
                        <input matInput type="time" 
                              formControlName="horaFim"           
                              
                              required               
                             >
                    </mat-form-field>                      
                </div>
                <div>    
                    <div *ngIf="agenda == undefined">
                        <!--Cliente-->
                        <mat-form-field  appearance="fill" class="comboCliente" >                            
                            <mat-select 
                                formControlName="codigoCliente"
                                matTooltip="Selecione um cliente"                                                                        
                                required>
                                <mat-option *ngFor="let cliente of optionClientes" [value]="cliente.codigo">
                                    {{ cliente.nome }}
                                </mat-option>
                            </mat-select>
                            <mat-label>Selecione o Cliente</mat-label>
                        </mat-form-field>
                    </div>               
                    <div *ngIf="agenda != undefined">
                        <mat-form-field class="comboCliente"  appearance="fill">
                            <mat-label>Cliente</mat-label>
                            <input matInput  disabled  value="{{agenda.cliente.nome}}">
                          </mat-form-field>
                    
                    </div>     
                    <!--Observacao do agendamento do cliente-->
                    <div style="width: 100%;">
                        <mat-form-field appearance="fill" class="observacao">
                            <mat-label>Observa&ccedil;&atilde;o do Agendamento</mat-label>
                            <textarea matInput #message maxlength="300" 
                              placeholder="Digite uma observação" 
                              cdkTextareaAutosize
                              formControlName ="observacaoCliente"></textarea>
                            <mat-hint align="start"><strong>Por favor, digite apenas a quantidade permitida.</strong>
                            </mat-hint>
                            <mat-hint align="end">{{message.value.length}} / 300</mat-hint>
                        </mat-form-field>
                    </div>
                </div>
                <mat-divider></mat-divider>
                <div>                    
                    <input id="tituloListaServico" name = "tituloListaServico" readonly class="tituloListaServicos" value="Servi&ccedil;o(s)"/>
                </div>
                <mat-divider></mat-divider>
                <div>
                    <!--Profissional-->
                    <mat-form-field *ngIf="optionProfissional" appearance="fill" class="comboProfissional">
                        <mat-label for="cboProfissional">Selecione o profissional</mat-label>
                        <mat-select formControlName="codigoProfissional" matTooltip="Profissional" 
                            (selectionChange)="listaServicos($event)"
                            [disabled]="permitidoGravarOuEditar === false"
                            name = "cboProfissional">
                            <mat-option *ngFor="let option of optionProfissional" [value]="option.codigo">
                                {{ option.nome }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                    <!--Serviço-->
                    <mat-form-field *ngIf="optionServicos" appearance="fill" class="comboServico">
                        <mat-label>Selecione o Servi&ccedil;o</mat-label>
                        <mat-select formControlName="codigoServico" matTooltip="Serviço" 
                            (selectionChange)="recuperarValorServico()"
                            [disabled]="permitidoGravarOuEditar === false"
                            >
                            <mat-option *ngFor="let servico of optionServicos" [value]="servico.codigo">
                                {{ servico.descricao }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                    <!--valor do servico-->                  
                    <mat-form-field appearance="fill" class="campoValor">
                        <mat-label>Valor</mat-label>
                        <input matInput 
                        type="number"
                        class="alinharADireita"
                        formControlName="valorServico"                  
                        autocomplete="off"
                        placeholder="Valor do serviço selecionado"
                        placeholder="0.000,00"                           
                        readonly>
                    </mat-form-field>
                </div>
                <!--Observacao-->
                <div style="width: 100%;">
                    <mat-form-field appearance="fill" class="observacao">
                        <mat-label>Observa&ccedil;&aacute;o</mat-label>
                        <textarea matInput #message maxlength="300" 
                          placeholder="Digite uma observação" 
                          cdkTextareaAutosize
                          formControlName ="observacao"
                          [readonly]="this.formulario.get('codigoProfissional').value == undefined || this.formulario.get('codigoServico').value==undefined"
                          [disabled]="permitidoGravarOuEditar === false"></textarea>
                        <mat-hint align="start"><strong>Por favor, digite apenas a quantidade permitida.</strong>
                        </mat-hint>
                        <mat-hint align="end">{{message.value.length}} / 300</mat-hint>
                    </mat-form-field>
                </div>
                <div style="width: 100%;" *ngIf="this.formulario.get('codigoProfissional').value == undefined || this.formulario.get('codigoServico').value==undefined">
                    <mat-form-field class="mensagemObservacaoServico" appearance="fill">
                        <mat-label>Mensagem</mat-label>
                        <input matInput id="mensagemDigitacaoObservacao" disabled value="Atenção!O campo observação do serviço está editável somente quando for selecionado um profissional e serviço." class="observacao">
                      </mat-form-field>
                </div>
                <mat-divider>

                </mat-divider>     
                <!--BOTOES DE ADICIONAR E REMOVER--> 
                <div>
                    <button mat-raised-button color="primary" 
                            type="button"
                            class="full" 
                            align="end"                             
                            (click)="adicionarNaLista()"
                            [disabled]="this.formulario.get('codigoServico').value == null || this.formulario.get('codigoServico').value == 0 ||  permitidoGravarOuEditar === false"
                            >
                            Adicionar
                            &nbsp;<i class="material-icons right">add</i></button>

                    <button mat-raised-button  type="button" color="accent" class="full" align="end" [disabled]="selection.selected.length == 0 || permitidoGravarOuEditar === false " (click)="removerLista()">Remover
                            &nbsp;<i class="material-icons right">remove</i></button>                            
                </div>
                <br />
                <mat-divider></mat-divider>
                <div>                    
                     
                    <input id="listaServAdd" class="tituloListaServicos" value="Lista de servi&ccedil;o(s) - adicionado(s) - Valor Total = {{ valorTotalServico |  number : '1.2-2':'pt' }}"/></div>
                     
                <mat-divider></mat-divider>

                <!--TABELA DE SERVICOS-->
                <div style = "text-align: center;">
                    <br/>
                    <table mat-table [dataSource]="dataSource" 
                    class="mat-elevation-z8" 
                        [hidden]="listaServicosTabela.length == 0" 
                        style="text-align:left;"
                        aria-describedby="mydesc"
                        >

                        <!-- Checkbox Column -->
                        <ng-container matColumnDef="select">
                          <th mat-header-cell *matHeaderCellDef>
                            <mat-checkbox (change)="$event ? masterToggle() : null"
                                          [checked]="selection.hasValue() && isAllSelected()"
                                          [indeterminate]="selection.hasValue() && !isAllSelected()"
                                          [aria-label]="checkboxLabel()">
                            </mat-checkbox>
                          </th>
                          <td mat-cell *matCellDef="let row">
                            <mat-checkbox (click)="$event.stopPropagation()"
                                          (change)="$event ? selection.toggle(row) : null"
                                          [checked]="selection.isSelected(row)"
                                          [aria-label]="checkboxLabel(row)">
                            </mat-checkbox>
                          </td>
                        </ng-container>
                      
                        <!-- Item Column -->
                        <ng-container matColumnDef="item">
                          <th mat-header-cell *matHeaderCellDef> item </th>
                          <td mat-cell *matCellDef="let element"> {{element.item}} </td>
                        </ng-container>
                      
                        <!-- Profissional Column -->
                        <ng-container matColumnDef="nomeProfissional">
                          <th mat-header-cell *matHeaderCellDef> Profissional </th>
                          <td mat-cell *matCellDef="let element"> {{element.nomeProfissional}} </td>
                        </ng-container>
                      
                        <!-- servico Column -->
                        <ng-container matColumnDef="nomeServico">
                          <th mat-header-cell *matHeaderCellDef> Servi&ccedil;o </th>
                          <td mat-cell *matCellDef="let element"> {{element.nomeServico}} </td>
                        </ng-container>
                        <!-- valor do servico Column -->
                        <ng-container matColumnDef="valorServico">
                            <th mat-header-cell *matHeaderCellDef> Valor </th>
                            <td mat-cell *matCellDef="let element"> {{element.valorServico | currency:'BRL':'symbol':'1.2-2':'pt'}} </td>
                          </ng-container>
                        <!-- descricaoSituacao -->
                        <ng-container matColumnDef="descricaoSituacao">
                            <th mat-header-cell *matHeaderCellDef> Situa&ccedil;&atilde;o </th>
                            <td mat-cell *matCellDef="let element"> {{element.descricaoSituacao}} </td>
                          </ng-container>
                        <!-- descricao cobranca Column -->
                        <ng-container matColumnDef="descricaoSituacaoCobranca">
                            <th mat-header-cell *matHeaderCellDef> Cobran&ccedil;a</th>
                            <td mat-cell *matCellDef="let element"> {{element.descricaoSituacaoCobranca}} </td>
                          </ng-container>
                        <!-- observacao Column -->
                        <ng-container matColumnDef="observacao">
                          <th mat-header-cell *matHeaderCellDef> Observa&ccedil;&aacute;o</th>
                          <td mat-cell *matCellDef="let element"> {{element.observacao}} </td>
                        </ng-container>
                        <!-- action -->
                        <ng-container matColumnDef="action">
                            <th mat-header-cell *matHeaderCellDef></th>
                            <td mat-cell *matCellDef="let element">                                  
                                <button
                                    type="button"
                                    mat-mini-fab
                                    color="primary"
                                    aria-label="Editar a observacao do serviço"
                                    (click)="openDialogEditarServico(element.agendaServico)"
                                    [disabled]="element.descricaoSituacao!=='PENDENTE'"
                                >
                                    <mat-icon>edit</mat-icon>
                                </button>                               
                            </td>
                          </ng-container>
                        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                            (click)="selection.toggle(row)">
                        </tr>
                      </table>
                      <br/>
                </div>
                <!-- BOTOES -->
                <mat-divider></mat-divider>
                <div>
                    <!--estorno de Pagamento do cliente-->
                    <button mat-raised-button type="button" class="botaoEstorno" align="end"  
                        [disabled] ="!habilitarEstorno"
                    (click)="openDialogEstorno()">Estorno
                        &nbsp;<i class="material-icons right">money_off</i></button>

                    <!--Pagamento do cliente-->
                    <button mat-raised-button type="button" class="botaoPagamento" align="end"  
                            [disabled]="!habilitarBotaoPagamento" 
                            (click)="openDialogPagamento()">Pagamento
                        &nbsp;<i class="material-icons right">payments</i></button>
                    <!--Cancelamento-->
                    <button mat-raised-button color="warn" 
                            type="button" 
                            class="full" 
                            align="end"  
                            [disabled]="!habilitarBotaoCancelamento"
                            (click)="cancelarServico()">
                            Cancelar&nbsp;
                            <i class="material-icons right">cancel</i></button>
                    <!--salvar-->
                    <button mat-raised-button color="primary" class="full" align="end" [disabled]="!formulario.valid ||listaServicosTabela.length === 0|| permitidoGravarOuEditar === false" >Salvar
                        &nbsp;<i class="material-icons right">save</i></button>
                    <!--retornar-->
                    <button mat-raised-button color="primary" class="full" align="end" [routerLink]="['/agenda']">Retornar
                        &nbsp;<i class="material-icons right">reply</i></button>
                </div>         
                
            </form>
        </mat-card-content>
    </mat-card>
</div>
